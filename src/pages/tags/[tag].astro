---
import BaseLayout from '../../layouts/BaseLayout.astro';

// 这是一个特殊的函数，告诉 Astro 你的网站有哪些动态路由（比如 /tags/math, /tags/cs）
export async function getStaticPaths() {
  // 注意这里的路径：.. 代表回到 src/pages，然后进入 posts
  const allPosts = Object.values(import.meta.glob('../posts/*.{md,mdx}', { eager: true }));
  
  // 提取所有不重复的标签
  const uniqueTags = [...new Set(allPosts.map((post: any) => post.frontmatter.tags).flat())];

  // 为每个标签生成一个页面路径
  return uniqueTags.map((tag) => {
    // 筛选出包含当前标签的文章
    const filteredPosts = allPosts.filter((post: any) => post.frontmatter.tags.includes(tag));
    // 按时间倒序排列
    filteredPosts.sort((a, b) => new Date(b.frontmatter.pubDate).valueOf() - new Date(a.frontmatter.pubDate).valueOf());
    
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

// 获取通过 getStaticPaths 传递进来的数据
const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout pageTitle={`Tag: ${tag}`}>
  <!-- 顶部面包屑导航 -->
  <div class="mb-12">
    <a href="/tags" class="text-sm text-gray-400 hover:text-black transition-colors font-sans mb-2 block">
      ← Back to Tags
    </a>
    <h1 class="text-3xl font-bold font-sans capitalize">#{tag}</h1>
    <p class="text-gray-500 mt-2 font-serif italic">
      Found {posts.length} {posts.length === 1 ? 'post' : 'posts'} in this collection.
    </p>
  </div>
  
  <!-- 文章列表 -->
  <ul class="space-y-12">
    {posts.map((post) => (
      <li class="group">
        <a href={post.url} class="block border-l-2 border-transparent hover:border-gray-200 pl-4 transition-all -ml-4">
            <h2 class="text-xl font-bold font-serif text-gray-800 group-hover:text-black mb-1">
              {post.frontmatter.title}
            </h2>
            <div class="flex items-center gap-4 text-sm text-gray-400 font-sans">
              <time>{post.frontmatter.pubDate.toString().slice(0,10)}</time>
              <span class="text-gray-300">|</span>
              <p class="truncate max-w-md">{post.frontmatter.description}</p>
            </div>
        </a>
      </li>
    ))}
  </ul>
</BaseLayout>