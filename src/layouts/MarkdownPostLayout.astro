---
import BaseLayout from './BaseLayout.astro';
import Comments from '../components/Comments.astro';
const { frontmatter } = Astro.props;

const currentUrl = Astro.url.href;
---
<BaseLayout pageTitle={frontmatter.title}>
  <article>
    <!-- 文章头部信息 -->
    <header class="mb-10 text-center">
      <h1 class="text-3xl font-bold mb-4 font-sans text-gray-900">{frontmatter.title}</h1>
      <div class="flex justify-center gap-4 text-sm text-gray-500 font-sans">
        <p>{frontmatter.pubDate.toString().slice(0,10)}</p>
        <div class="flex gap-2">
          {frontmatter.tags.map((tag: string) => (
            <span class="bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-600">#{tag}</span>
          ))}
        </div>
      </div>
    </header>

    <!-- 文章正文：prose-slate 设定灰度，prose-lg 增大字号利于阅读 -->
    <div class="prose prose-slate prose-lg max-w-none prose-headings:font-sans prose-a:text-blue-600 hover:prose-a:text-blue-400 prose-img:rounded-lg prose-img:shadow-sm">
      <slot />
    </div>

    <!-- ============================================ -->
    <!-- ============================================ -->
    <div class="mt-24 pt-8 border-t border-gray-200">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <!-- 左侧：作者与协议 -->
        <div class="space-y-6">
          <div>
            <span class="block text-xs text-gray-400 font-sans font-bold tracking-widest uppercase mb-1">
              Author
            </span>
            <span class="font-serif text-lg text-gray-900 italic">
              mdlws
            </span>
          </div>
          <div>
            <span class="block text-xs text-gray-400 font-sans font-bold tracking-widest uppercase mb-1">
              License
            </span>
            <a 
              href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" 
              target="_blank" 
              rel="noopener noreferrer"
              class="font-serif text-gray-600 hover:text-black border-b border-gray-200 hover:border-black transition-all pb-0.5"
            >
              CC BY-NC-SA 4.0
            </a>
          </div>
        </div>

        <!-- 右侧：永久链接 -->
        <div>
          <span class="block text-xs text-gray-400 font-sans font-bold tracking-widest uppercase mb-1">
            Permalink
          </span>
          <a href={currentUrl} class="font-mono text-sm text-gray-500 hover:text-black break-all transition-colors">
            {currentUrl}
          </a>
          <p class="text-xs text-gray-300 mt-2 font-serif">
            转载请保留原文链接与作者署名。
          </p>
        </div>

      </div>
    </div>

  </article>

  <Comments />
  <script>
    // 等待页面内容加载完成
    document.addEventListener('DOMContentLoaded', () => {
      // 1. 找到文章内所有的 <pre> 标签 (Shiki 生成的代码块)
      const pres = document.querySelectorAll('article pre');

      pres.forEach((pre) => {
        // 防止重复处理
        if (pre.parentNode.classList.contains('code-block-content')) return;

        // 2. 获取代码语言 (Shiki 通常会给 code 加 class="language-js")
        const code = pre.querySelector('code');
        // 从 class 中提取语言，比如 "language-js" -> "JS"
        // 如果找不到，默认为 "CODE"
        let language = 'CODE';
        if (code) {
          const langClass = Array.from(code.classList).find(c => c.startsWith('language-'));
          if (langClass) {
            language = langClass.replace('language-', '').toUpperCase();
          }
        }

        // 3. 创建结构
        // 目标结构:
        // <div class="code-block-wrapper">
        //    <div class="code-block-header"> ... </div>
        //    <div class="code-block-content"> <pre>...</pre> </div>
        // </div>

        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';

        const header = document.createElement('div');
        header.className = 'code-block-header';

        // 头部内容：语言标签 + 折叠按钮
        header.innerHTML = `
          <span class="code-language-label">${language}</span>
          <button class="code-collapse-btn" aria-label="Toggle code">
            <span>Hide</span>
            <svg class="code-collapse-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
        `;

        const content = document.createElement('div');
        content.className = 'code-block-content';

        // 4. 移动 DOM 元素
        // 将 wrapper 插入到 pre 之前
        pre.parentNode.insertBefore(wrapper, pre);
        // 将 pre 移入 content
        content.appendChild(pre);
        // 将 header 和 content 移入 wrapper
        wrapper.appendChild(header);
        wrapper.appendChild(content);

        // 5. 添加交互逻辑
        const btn = header.querySelector('.code-collapse-btn');
        const btnText = btn.querySelector('span');
        
        header.addEventListener('click', () => {
          wrapper.classList.toggle('collapsed');
          
          // 更新按钮文字
          if (wrapper.classList.contains('collapsed')) {
            btnText.textContent = 'Show';
          } else {
            btnText.textContent = 'Hide';
          }
        });
      });
    });
  </script>
</BaseLayout>